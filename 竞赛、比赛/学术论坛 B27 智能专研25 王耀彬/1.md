##### 基于Unicloud的苏绣数字博物馆

1.项目概述：

- 面向“苏绣”这一国家级非遗题材打造的数字叙事体验，定位于教学展示、文化传播与沉浸式互动三位一体的线上数字博物馆。
- 采用 Uni-App 跨端框架承载移动端与 Web 浏览器，结合 `Three.js` 高精 3D 场景、Unity WebGL 互动关卡与剧情问答式教学，将静态资料转化为可探索、可沉浸、可量化的学习路径。
- 通过 UniCloud 云函数与云数据库构建轻量后端，实现`“注册/登录 → 场景互动 → 行为采集 → 问卷回传”`的闭环；行为数据实时写入云端，方便教学评估与运营分析。
- 工程结构遵循“页面层(pages)+ 组件层(components)+ 云函数层(uniCloud)+ 静态资源层(static)”的模块化划分，便于模型、视频、游戏、问卷等内容按需扩展。
- 允许公网访问[static-mp-ff0658fc-ae23-43b3-8ef6-bf182cf4cbbc.next.bspapp.com](https://static-mp-ff0658fc-ae23-43b3-8ef6-bf182cf4cbbc.next.bspapp.com/)



2.技术栈==AI辅助总结==：

- **前端框架与语言**：基于 Uni-App(Vue 2 + Composition API)
  - ![image-20251019135245459](D:\Study\CS Study\Note 2024-\All Photo\image-20251019135245459.png)

- **三维渲染管线**：Three.js 渲染；GLTFLoader 读取模型、DRACOLoader 解码压缩几何、OrbitControls 控制相机、RGBELoader + PMREMGenerator 生成 HDR 光照；Raycaster 用于拾取 NPC 与信息牌。
  - 以室内博物馆的3D场景为例
  - ![image-20251019135557955](D:\Study\CS Study\Note 2024-\All Photo\image-20251019135557955.png)

- **游戏化模块**：Unity + WebGL 导出，部署在 static/unitygame/，通过 iframe 容器承载，并借 window.postMessage 实现与 Vue 组件的数据交换。
  - ![image-20251019135510468](D:\Study\CS Study\Note 2024-\All Photo\image-20251019135510468.png)

- ==**后端与云函数**：依托 UniCloud(阿里云)提供的 Node.js 云函数环境与 MongoDB 兼容数据库；主要云函数包括 login_register、get_major_list、getModelUrl、getVideoUrl、updateUserBehavior、updateAndCheckAnswer，分别负责认证、枚举、资源映射、行为日志与问卷读写。==
  - ![image-20251019135620744](D:\Study\CS Study\Note 2024-\All Photo\image-20251019135620744.png)
  - ![image-20251019135631049](D:\Study\CS Study\Note 2024-\All Photo\image-20251019135631049.png)****
  - ![image-20251019135650703](D:\Study\CS Study\Note 2024-\All Photo\image-20251019135650703.png)
  - 

- `数据缓存与本地状态：使用 uni.setStorageSync/uni.getStorageSync 保存 userInfo、userBehaviorRecord、问卷答案等，保证跨页面与离线场景下的体验连续性。`
- **资源与部署**：模型与视频统一托管在 `UniCloud CDN`，减少首屏加载延迟；Three.js DRACO 解码器置于 static/draco/，Unity WebGL 资源与 Shader 等静态文件直接随前端打包。
  - ![image-20251019135723004](D:\Study\CS Study\Note 2024-\All Photo\image-20251019135723004.png)

- **账号初始化阶段**：登录页(login_register.vue)在提交前校验四项必填字段，先构造临时 userBehaviorRecord 并调用 updateUserBehavior 建档；随后触发 login_register 云函数，若存在用户则校验密码与学号并返回档案，若不存在则创建默认 access_record/NPC 记录并写入数据库，返回值统一缓存在 userInfo。
  - 检测昵称/用户名是否存在，不存在则创建新账户
  - 自动检索专业，下拉选择
  - ![image-20251019135132500](D:\Study\CS Study\Note 2024-\All Photo\image-20251019135132500.png)
  - ![image-20251019135155173](D:\Study\CS Study\Note 2024-\All Photo\image-20251019135155173.png)

- **外场(StartPage)加载链路**：StartPage 组件加载后读取 userInfo.access_record 决定是否调用 getVideoUrl 播放引导视频，同时调用 getModelUrl 获取室外模型地址。NPC 对话阶段调用 DialogueBoxForOutSide.startDialogue，对话结束立即通过 uniCloud.database() 更新 user.outside_npc_record 并同步本地缓存；进入章节按钮前执行 reportOutsideEnd，再次调用 updateUserBehavior 写入室外停留时长。
- **室内展区交互**：InsideModel 组件初始化时记录 inside_start_time 并通过 URL 参数定位展柜。章节按钮点击会先补齐上一章节的 end_time/duration，再推入新的章节记录。若章节要求观看视频，则调用 getVideoUrl，播放完成后写入 access_record 并更新数据库。NPC 对话调用 DialogueBoxForInside，结束后更新 inside_npc_record 并隐藏 Sprite。
- **Unity WebGL 游戏数据回传**：点击“数字苏绣·游戏体验”按钮时设置 access_record[7] 为 1 并同步云端，同时暂停 Three.js 渲染循环。Unity 端完成体验后通过 postMessage({ type: 'reportAndExit', payload }) 回传总时长与关卡时长，UnityGame 组件接收后更新本地 userBehaviorRecord 并调用 updateUserBehavior；随后关闭 iframe，恢复 Three.js 渲染。
- **问卷提交流程**：问卷入口按钮需满足所有章节访问 + 游戏体验完成的条件才解锁。点击后会先调用 updateUserBehavior 同步最新行为，再跳转问卷页面(questionnaire.vue)。问卷页面初始化即调用 updateAndCheckAnswer 拉取历史答案填充；点击“保存”时将答案数组传入同一云函数，实现幂等覆盖写入 user.questions，并刷新本地缓存。
- **兜底与会话结束逻辑**：InsideModel 的 onBeforeUnmount 钩子在用户离开前补齐当前章节的 end_time、小游戏时长、室内停留时间等字段，并调用 updateUserBehavior 最终同步数据；同时重新写入本地 userBehaviorRecord，保证用户下次登录仍可继续上报未完成的行为链路。
- ==**云函数与云数据库调用机制补充**：前端通过 uniCloud.callFunction({ name, data }) 将业务参数打包为 event 对象传入云端，云函数内部可通过 uniCloud.database() 获取集合句柄，执行 where、doc、update、add 等操作。所有调用默认运行在服务空间的安全上下文中，无需额外鉴权；当需要在前端直连数据库时(如 startpage 中更新 NPC 记录)，同样使用 uniCloud.database()，由平台根据当前绑定的服务空间和登录态执行权限校验。返回值使用 Promise 语义，前端以 await 等待结果后再更新 UI 或本地缓存，形成可追踪、可重放的调用链路。==



3.产品功能性解释==AI辅助总结==

- **外场迎宾与三维导览**：StartPage 入口页（startpage.vue 的 setup）通过 THREE.Scene、GLTFLoader、DRACOLoader 与 OrbitControls 构建高精度户外场景。onMounted 中的渲染循环负责保持 60fps 体验；loadIntroVideo 和 replayIntroVideo 根据 access_record 管理序章视频播放；handlePointerUp 利用 Raycaster 精准拾取 NPC Anchor，动态定位对话框。
  - ![image-20251019135753482](D:\Study\CS Study\Note 2024-\All Photo\image-20251019135753482.png)
  - ![image-20251019135808969](D:\Study\CS Study\Note 2024-\All Photo\image-20251019135808969.png)

- **室内章节化探索**：InsideModel 组件（insidemodelpage.vue）在 setup 中通过 goToChapter 将相机移动到模型内的命名锚点，结合 checkAndPlayVideo 的串行 Promise 机制确保章节视频按顺序播放。loadProgress 细分模型下载、解析、问号贴图加载等阶段，让进度条与实际加载同步。
- **视频资源与信息注释联动**：getVideoUrl 云函数提供 CDN 映射；前端的 playVideoSequence 在 watch(showVideo) 中监听视频关闭事件，自动写入访问位。TextTooltip 利用 worldToScreen 计算的屏幕坐标 + 延迟定时器，在 Three.js 模型平面上实现“悬停 900ms 后显示长文案”的交互。









